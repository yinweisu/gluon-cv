name: CI workflow

on:
  push:
    # branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest]
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v1.7.0
        with:
          auto-update-conda: true
          python-version: 3.7
      - name: sanity-check
        shell: bash -l {0}
        run: |
            conda env create -n gluon_cv_lint -f ./tests/pylint.yml
            conda env update -n gluon-cv-lint -f ./tests/pylint.yml --prune
            conda activate gluon-cv-lint
            conda list
            make clean
            make pylint
      # - name: build-docs
      #   shell: bash -l {0}
      #   run: |
      #       conda env create -n gluon_vision_docs -f docs/build.yml
      #       conda env update -n gluon_vision_docs -f docs/build.yml --prune
      #       conda activate gluon_vision_docs
      #       export PYTHONPATH=\${PWD}
      #       export CUDA_VISIBLE_DEVICES=0
      #       env
      #       export LD_LIBRARY_PATH=/usr/local/cuda-10.0/lib64
      #       git submodule update --init --recursive
      #       git clean -fx
      #       pip install --upgrade --force-reinstall --no-deps .
      #       echo done pip install
      #       echo make file
      #       cd docs && make clean && make html
      - name: unit-test
        shell: bash -l {0}
        run: |
            conda env create -n gluon_cv_py3_test -f tests/py3.yml
            conda env update -n gluon_cv_py3_test -f tests/py3.yml --prune
            conda activate gluon_cv_py3_test
            conda list
            export CUDA_VISIBLE_DEVICES=0
            export KMP_DUPLICATE_LIB_OK=TRUE
            make clean
            pip install --upgrade --force-reinstall --no-deps .
            env
            export LD_LIBRARY_PATH=/usr/local/cuda-10.0/lib64
            export MPLBACKEND=Agg
            export MXNET_CUDNN_AUTOTUNE_DEFAULT=0
            nosetests --with-timer --timer-ok 5 --timer-warning 20 --with-coverage --cover-package gluoncv -v tests/unittests
            nosetests --with-timer --timer-ok 5 --timer-warning 20 --with-coverage --cover-package gluoncv -v tests/model_zoo
            